# Semgrep Rules for BFF Security Boundaries
# Enforces .cursor/rules/bff-security-boundaries.mdc
#
# Run: semgrep --config .semgrep/ apps/frontend/src/

rules:
  # ============================================
  # 1. NO DIRECT DATABASE ACCESS IN FRONTEND
  # ============================================

  - id: bff-no-frontend-database-supabase
    message: |
      Frontend code must NOT access Supabase directly for data queries.
      Use the BFF API layer instead: fetch('/api/...').

      Direct database access violates security boundaries and enables
      lateral movement if RCE occurs in the frontend.

      See: .cursor/rules/bff-security-boundaries.mdc
    severity: ERROR
    metadata:
      category: security
      subcategory: architecture
      cwe: "CWE-284: Improper Access Control"
      confidence: HIGH
      references:
        - ".cursor/rules/bff-security-boundaries.mdc"
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
    pattern-either:
      - pattern: |
          import { createClient } from '@supabase/supabase-js'
      - pattern: |
          import { createClient } from "@supabase/supabase-js"
      - pattern: |
          $CLIENT.from($TABLE)
      - pattern: |
          supabase.from($TABLE)

  - id: bff-no-frontend-database-drivers
    message: |
      Database drivers (pg, Prisma, Drizzle) are FORBIDDEN in frontend code.
      All database access must go through the BFF API layer.
    severity: ERROR
    metadata:
      category: security
      subcategory: architecture
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
    pattern-either:
      - pattern: import { Pool } from 'pg'
      - pattern: import pg from 'pg'
      - pattern: import { PrismaClient } from '@prisma/client'
      - pattern: import { drizzle } from 'drizzle-orm'
      - pattern: require('pg')
      - pattern: require('@prisma/client')

  # ============================================
  # 2. NO SERVICE CREDENTIALS IN FRONTEND
  # ============================================

  - id: bff-no-frontend-service-keys
    message: |
      Service role keys and database URLs must NEVER be in frontend code.
      These credentials bypass Row Level Security and enable full database access.

      Use NEXT_PUBLIC_* or VITE_* prefixed PUBLIC keys only.
    severity: ERROR
    metadata:
      category: security
      subcategory: secrets
      cwe: "CWE-798: Use of Hard-coded Credentials"
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
    pattern-either:
      - pattern: process.env.SUPABASE_SERVICE_ROLE_KEY
      - pattern: process.env.SUPABASE_SECRET_KEY
      - pattern: process.env.DATABASE_URL
      - pattern: process.env.SUPABASE_DATABASE_URL
      - pattern: process.env.OPENROUTER_API_KEY
      - pattern: process.env.SPOTIFY_CLIENT_SECRET
      - pattern: process.env.GOOGLE_PLACES_API_KEY
      - pattern: process.env.EXA_API_KEY
      - pattern: import.meta.env.VITE_SECRET_KEY
      - pattern: import.meta.env.VITE_SERVICE_ROLE_KEY

  - id: bff-no-frontend-secret-patterns
    message: |
      Environment variable appears to contain a secret (SECRET, KEY, PASSWORD, TOKEN).
      Frontend code should only access public/anon keys.
    severity: WARNING
    metadata:
      category: security
      subcategory: secrets
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
    patterns:
      - pattern: process.env.$VAR
      - metavariable-regex:
          metavariable: $VAR
          regex: ".*(SECRET|PASSWORD|PRIVATE|SERVICE_ROLE).*"
      - pattern-not: process.env.NEXT_PUBLIC_$X
      - pattern-not: process.env.VITE_$X

  # ============================================
  # 3. NO CHILD_PROCESS IN FRONTEND
  # ============================================

  - id: bff-no-frontend-child-process
    message: |
      child_process module is FORBIDDEN in frontend code.
      This prevents RCE exploitation if frontend is compromised.
      Backend services should handle system commands.

      CVE Reference: Mintlify CVE-2025-67843
    severity: ERROR
    metadata:
      category: security
      subcategory: code-execution
      cwe: "CWE-78: OS Command Injection"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-67843"
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/**"
    pattern-either:
      - pattern: import { exec } from 'child_process'
      - pattern: import { spawn } from 'child_process'
      - pattern: import { execSync } from 'child_process'
      - pattern: import { spawnSync } from 'child_process'
      - pattern: import { fork } from 'child_process'
      - pattern: import { execFile } from 'child_process'
      - pattern: import * as $X from 'child_process'
      - pattern: const $X = require('child_process')
      - pattern: require('child_process').$METHOD(...)

  # ============================================
  # 4. NO EVAL IN FRONTEND
  # ============================================

  - id: bff-no-frontend-eval
    message: |
      eval() and new Function() are FORBIDDEN in frontend code.
      These enable code injection attacks.

      Use JSON.parse() for data parsing, not code execution.

      CVE Reference: Mintlify CVE-2025-67843 (MDX expression execution)
    severity: ERROR
    metadata:
      category: security
      subcategory: code-injection
      cwe: "CWE-95: Improper Neutralization of Directives in Dynamically Evaluated Code"
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/**"
    pattern-either:
      - pattern: eval(...)
      - pattern: new Function(...)
      - pattern: window.eval(...)
      - pattern: globalThis.eval(...)
      - pattern: (0, eval)(...)

  # ============================================
  # 5. NO FILESYSTEM ACCESS IN FRONTEND
  # ============================================

  - id: bff-no-frontend-filesystem
    message: |
      Filesystem access (fs module) is FORBIDDEN in frontend code.
      This prevents file exfiltration if RCE occurs.
    severity: ERROR
    metadata:
      category: security
      subcategory: file-access
      cwe: "CWE-22: Path Traversal"
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
    pattern-either:
      - pattern: import fs from 'fs'
      - pattern: import * as fs from 'fs'
      - pattern: import { $X } from 'fs'
      - pattern: import { $X } from 'fs/promises'
      - pattern: const $X = require('fs')
      - pattern: require('fs').$METHOD(...)

  # ============================================
  # 6. ENFORCE API CLIENT USAGE
  # ============================================

  - id: bff-prefer-api-client
    message: |
      Consider using the centralized API client instead of direct fetch().
      This ensures consistent auth, error handling, and logging.

      Import: import { api } from '@/lib/api'
      Usage:  api.get('/api/events')
    severity: WARNING
    metadata:
      category: best-practice
      subcategory: architecture
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
      exclude:
        - "apps/frontend/src/lib/api.ts"
        - "apps/frontend/src/lib/api.js"
    patterns:
      - pattern: fetch($URL, ...)
      - pattern-not: fetch("/api/...", ...)
      - pattern-not: fetch('/api/...', ...)
      - pattern-not-inside: |
          export const api = { ... }

  # ============================================
  # 7. NO DYNAMIC IMPORTS WITH USER INPUT
  # ============================================

  - id: bff-no-dynamic-import-user-input
    message: |
      Dynamic imports with variable paths can lead to code injection.
      Use static imports or validate against an allowlist.
    severity: ERROR
    metadata:
      category: security
      subcategory: code-injection
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
    patterns:
      - pattern: import($PATH)
      - metavariable-pattern:
          metavariable: $PATH
          patterns:
            - pattern-not: "..."

  # ============================================
  # 8. NO SERVER-SIDE USER CODE EXECUTION
  # ============================================

  - id: bff-no-ssr-user-code
    message: |
      Rendering user-provided JSX/MDX expressions enables RCE.
      This is exactly what caused Mintlify CVE-2025-67843.

      Sanitize or strip expressions from user content before rendering.
    severity: ERROR
    metadata:
      category: security
      subcategory: code-injection
      cwe: "CWE-94: Improper Control of Generation of Code"
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/**"
    pattern-either:
      - pattern: renderToString(<>{$USER_CONTENT}</>)
      - pattern: compile($USER_CONTENT)
      - pattern: $MDX.compile($USER_CONTENT)

  # ============================================
  # 9. PYTHON - API ROUTES SHOULD HAVE AUTH
  # ============================================

  - id: bff-python-api-requires-auth
    message: |
      API routes should verify user authentication.
      Add `user: User = Depends(get_current_user)` parameter.

      Exception: Health check and public read endpoints.
    severity: WARNING
    metadata:
      category: security
      subcategory: authentication
    languages: [python]
    paths:
      include:
        - "apps/frontend/api/**"
        - "apps/*/api/**"
      exclude:
        - "**/*health*"
    patterns:
      - pattern-inside: |
          @app.$METHOD("$ROUTE")
          async def $FUNC(...):
              ...
      - pattern-not-inside: |
          @app.$METHOD("$ROUTE")
          async def $FUNC(..., user: User = Depends(get_current_user), ...):
              ...
      - pattern-not-inside: |
          @app.$METHOD("$ROUTE")
          async def $FUNC(..., user: $T = Depends(...), ...):
              ...
      - metavariable-regex:
          metavariable: $METHOD
          regex: "(post|put|patch|delete)"

  # ============================================
  # 10. CONSOLE.LOG IN FRONTEND (Warning)
  # ============================================

  - id: bff-no-console-log-production
    message: |
      console.log() exposes information to browser DevTools.
      Remove before production or use conditional logging.
    severity: WARNING
    metadata:
      category: security
      subcategory: information-disclosure
    languages: [typescript, javascript]
    paths:
      include:
        - "apps/frontend/src/**"
      exclude:
        - "**/*.test.*"
        - "**/*.spec.*"
    pattern-either:
      - pattern: console.log(...)
      - pattern: console.debug(...)
      - pattern: console.info(...)
